# Advanced Install

OpenShift is unique in that its management extends all the way down to the
operating system itself. Every machine boots with a configuration which
references resources hosted in the cluster its joining. This allows the cluster
to manage itself as updates are applied. A downside to this approach, however,
is that new clusters have no way of starting without external help - every
machine in the to-be-created cluster is waiting on the to-be-created cluster.

OpenShift breaks this dependency loop using a temporary bootstrap machine. This
bootstrap machine is booted with a concrete [Ignition Config][ignition] which
describes how to create the cluster. This machine acts as a temporary control
plane whose sole purpose is launching the rest of the cluster.

The main assets generated by the installer are the Ignition Configs for the
bootstrap, master, and worker machines. Given these three configs (and correctly
configured infrastructure), it is possible to start an OpenShift cluster. The
process for bootstrapping a cluster looks like the following:

  1. The bootstrap machine boots and starts hosting the remote resources
     required for the master machines to boot.
  2. The master machines fetch the remote resources from the bootstrap machine
     and finish booting.
  3. The master machines use the bootstrap node to form an etcd cluster.
  4. The bootstrap node starts a temporary Kubernetes control plane using the
     newly-created etcd cluster.
  5. The temporary control plane schedules the production control plane to the
     master machines.
  6. The temporary control plane shuts down, yielding to the production control
     plane.
  7. The bootstrap node injects OpenShift-specific components into the newly
     formed control plane.
  8. The installer then tears down the bootstrap node.

The result of this bootstrapping process is a fully running OpenShift cluster.
The cluster will then download and configure remaining components needed for the
day-to-day operation, including the creation of worker machines in supported
environments.

[ignition]:
https://github.com/coreos/ignition/blob/master/doc/getting-started.md

## Key Concepts

While striving to remain simple and easy to use, the installer allows many
aspects of the clusters it creates to be customized. It is helpful to understand
certain key concepts before attempting to customize the installation.

### Targets

The OpenShift Installer operates on the notion of creating and destroying
targets. Similar to other tools which operate on a graph of dependencies (e.g.
make, systemd), each target represents a subset of the dependencies in the
graph. The main target in the installer creates a cluster, but the other targets
allow the user to interrupt this process and consume or modify the intermediate
artifacts (e.g. the Kubernetes manifests that will be installed into the
cluster). Only the immediate dependencies of a target are written to disk by the
installer, but the installer can be invoked [multiple
times](#multiple-invocations).


#### install-config

The install config contains the main parameters for the installation process.
This configuration provides the user with more options than the interactive
prompts and comes pre-populated with default values.

```sh
openshift-install create install-config
cat install-config.yaml
sed '/.*pullSecret.*/{s///;q;}' install-config.yml 
baseDomain: devcluster.openshift.com
clusterID: 21ff9d3e-6aea-4cdf-81b2-54a2e68c2cf1
machines:
- name: master
  platform: {}
  replicas: 3
- name: worker
  platform: {}
  replicas: 3
metadata:
  creationTimestamp: null
  name: decarr
networking:
  clusterNetworks:
  - cidr: 10.128.0.0/14
    hostSubnetLength: 9
  serviceCIDR: 172.30.0.0/16
  type: OpenshiftSDN
platform:
  aws:
    region: us-east-2
    vpcCIDRBlock: 10.0.0.0/16
    vpcID: ""
```

A user is able to change the default information for domain, cluster id,
machines, networking, or platform specific data.

#### manifests

This target generates the default Kubernetes API manifests that will define
the cluster.  It also generates initial TLS values components like
etcd, kubelet, ingress, etc.

```sh
openshift-install create manifests
INFO Consuming "Install Config" from target directory 
```

The manifests are visible via the following:

```sh
ls manifests openshift
manifests:
04-openshift-machine-config-operator.yaml   cluster-network-02-config.yml               kube-system-configmap-root-ca.yaml
05-openshift-cluster-api-namespace.yaml     cvo-overrides.yaml                          kube-system-secret-etcd-client.yaml
09-openshift-service-signer-namespace.yaml  etcd-service.yaml                           machine-config-server-tls-secret.yaml
cluster-config.yaml                         host-etcd-service-endpoints.yaml            openshift-service-signer-secret.yaml
cluster-ingress-01-crd.yaml                 host-etcd-service.yaml                      pull.json
cluster-ingress-02-config.yml               kube-cloud-config.yaml
cluster-network-01-crd.yml                  kube-system-configmap-etcd-serving-ca.yaml

openshift:
99_binding-discovery.yaml                      99_openshift-cluster-api_master-user-data-secret.yaml
99_cloud-creds-secret.yaml                     99_openshift-cluster-api_worker-machineset.yaml
99_kubeadmin-password-secret.yaml              99_openshift-cluster-api_worker-user-data-secret.yaml
99_openshift-cluster-api_cluster.yaml          99_role-cloud-creds-secret-reader.yaml
99_openshift-cluster-api_master-machines.yaml
```

The TLS information is encoded in a default installer state file:

```sh
cat .openshift_install_state.json | grep tls/
                "Filename": "tls/etcd-client-ca.key",
                "Filename": "tls/etcd-client-ca.crt",
                "Filename": "tls/etcd-client.key",
                "Filename": "tls/etcd-client.crt",
                "Filename": "tls/ingress.key",
                "Filename": "tls/ingress.crt",
                "Filename": "tls/kube-ca.key",
                "Filename": "tls/kube-ca.crt",
                "Filename": "tls/kubelet.key",
                "Filename": "tls/kubelet.crt",
                "Filename": "tls/machine-config-server.key",
                "Filename": "tls/machine-config-server.crt",
                "Filename": "tls/root-ca.key",
                "Filename": "tls/root-ca.crt",
                "Filename": "tls/service-serving-ca.key",
                "Filename": "tls/service-serving-ca.crt",
```

#### ignition-configs

These are the three Ignition Configs for the bootstrap, master, and worker machines.

```sh
openshift-install create ignition-configs
WARNING   Discarding the "Common Manifests" that was provided in the target directory because its dependencies are dirty and it needs to be regenerated 
WARNING   Discarding the "Openshift Manifests" that was provided in the target directory because its dependencies are dirty and it needs to be regenerated 
INFO Consuming "Common Manifests" from target directory 
INFO Consuming "Network Config" from target directory 
INFO Consuming "Openshift Manifests" from target directory 
INFO Consuming "Ingress Config" from target directory 
```

The ignition files require the essential information needed to bootstrap a self managed cluster.
All the information previously created is collapsed into 3 ign files.

```sh
ls *.ign
bootstrap.ign  master.ign  worker.ign
cat boostrap.ign | jq .
```

#### cluster

This target provisions the final cluster.

```sh
openshift-install create cluster
INFO Creating cluster...                          
INFO Waiting 30m0s for the Kubernetes API...      
INFO API v1.11.0+99b66db up                       
INFO Waiting 30m0s for the bootstrap-complete event... 
INFO Destroying the bootstrap resources...        
INFO Using Terraform to destroy bootstrap resources... 
INFO kubeadmin user password: Seiv2-q9xJW-2rHR2-UGRRj 
INFO Install complete! The kubeconfig is located here: /home/decarr/go/src/github.com/openshift/installer/auth/kubeconfig 
```

## Supported Environments

  - AWS

Next: [Explore More](../03-explore.md)
